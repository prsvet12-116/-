<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∞–±–∏—Ä–∏–Ω—Ç –¢—å–º—ã - –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }
        
        body {
            background: #000;
            color: #e0e0e0;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        #game-canvas {
            display: block;
            background: #000;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 8px;
            border: 1px solid #333;
            backdrop-filter: blur(5px);
            min-width: 200px;
            z-index: 10;
        }
        
        .ui-element {
            margin: 12px 0;
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .crystal-icon {
            width: 16px;
            height: 16px;
            background: linear-gradient(45deg, #00ffff, #0088ff);
            border-radius: 50%;
            margin-right: 8px;
            box-shadow: 0 0 8px #00ffff;
            animation: pulse 2s infinite;
        }
        
        .key-icon {
            width: 20px;
            height: 12px;
            background: linear-gradient(to right, #ffaa00, #ff8800);
            margin-right: 8px;
            border-radius: 3px;
            box-shadow: 0 0 6px #ffaa00;
        }
        
        .heart-icon {
            color: #ff5555;
            margin: 0 3px;
            font-size: 16px;
            text-shadow: 0 0 5px #ff0000;
        }
        
        /* –ú–ï–ù–Æ */
        #menu-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, #1a1a2e 0%, #0a0a0a 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
        }
        
        .title {
            font-size: 3.5rem;
            color: #00ffff;
            text-shadow: 0 0 15px #00ffff, 0 0 30px #0088ff;
            margin-bottom: 10px;
            letter-spacing: 4px;
            text-align: center;
            animation: titleGlow 3s infinite alternate;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 30px;
            text-align: center;
            max-width: 600px;
            line-height: 1.5;
        }
        
        .game-description {
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            max-width: 600px;
            border: 1px solid #333;
        }
        
        .description-title {
            color: #00ffff;
            font-size: 1.1rem;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .description-text {
            color: #aaa;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .menu-button {
            background: rgba(34, 34, 34, 0.8);
            color: #00ffff;
            border: 2px solid #00ffff;
            padding: 12px 30px;
            margin: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            min-width: 200px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            backdrop-filter: blur(5px);
        }
        
        .menu-button:hover {
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.7);
            transform: translateY(-2px);
        }
        
        .developer {
            position: absolute;
            bottom: 20px;
            color: #666;
            font-size: 0.8rem;
        }
        
        /* –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù */
        #game-screen {
            display: none;
            width: 100%;
            height: 100%;
        }
        
        /* –≠–ö–†–ê–ù –ó–ê–í–ï–†–®–ï–ù–ò–Ø –£–†–û–í–ù–Ø */
        #level-complete {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border-radius: 10px;
            border: 2px solid #00ff00;
            text-align: center;
            display: none;
            z-index: 50;
            backdrop-filter: blur(10px);
            min-width: 300px;
        }
        
        .glowing-text {
            color: #00ff00;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        /* –í–´–ë–û–† –°–õ–û–ñ–ù–û–°–¢–ò */
        #difficulty-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #444;
            text-align: center;
            display: none;
            z-index: 150;
            backdrop-filter: blur(10px);
            min-width: 350px;
        }
        
        .difficulty-title {
            color: #00ffff;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        
        .difficulty-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }
        
        .difficulty-btn {
            padding: 12px 20px;
            background: rgba(34, 34, 34, 0.8);
            border: 1px solid #444;
            color: #ccc;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .difficulty-btn:hover {
            border-color: #00ffff;
            color: #00ffff;
            transform: translateX(5px);
        }
        
        .difficulty-btn.active {
            border-color: #00ffff;
            color: #00ffff;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            background: rgba(0, 255, 255, 0.1);
        }
        
        .difficulty-description {
            color: #888;
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: left;
            padding-left: 10px;
        }
        
        /* –ò–ù–°–¢–†–£–ö–¶–ò–Ø */
        #instructions-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #444;
            max-width: 500px;
            display: none;
            z-index: 150;
            backdrop-filter: blur(10px);
        }
        
        .instructions-title {
            color: #00ffff;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .instructions-content {
            color: #aaa;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .instructions-section {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }
        
        .instructions-section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            color: #00ffff;
            font-size: 1rem;
            margin-bottom: 8px;
        }
        
        /* –ö–ù–û–ü–ö–ò –ó–ê–ö–†–´–¢–ò–Ø */
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ccc;
            cursor: pointer;
            font-size: 20px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        /* –ê–ù–ò–ú–ê–¶–ò–ò */
        @keyframes pulse {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.7; transform: scale(1); }
        }
        
        @keyframes titleGlow {
            0% { text-shadow: 0 0 15px #00ffff, 0 0 30px #0088ff; }
            100% { text-shadow: 0 0 20px #00ffff, 0 0 40px #0088ff, 0 0 60px #0088ff; }
        }
        
        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 768px) {
            .title { font-size: 2.5rem; }
            .subtitle { font-size: 1rem; }
            #ui { 
                top: 10px; 
                left: 10px; 
                padding: 10px;
                font-size: 12px;
            }
            .menu-button { 
                padding: 10px 20px; 
                min-width: 180px; 
                font-size: 1rem;
                margin: 5px;
            }
            #difficulty-menu, #instructions-screen {
                width: 90%;
                min-width: unset;
                padding: 20px;
            }
        }
        
        /* –ö–û–ù–¢–†–û–õ–´ */
        #controls-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            color: #888;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
        <div id="menu-screen">
            <h1 class="title">–õ–ê–ë–ò–†–ò–ù–¢ –¢–¨–ú–´</h1>
            <p class="subtitle">–•–æ—Ä—Ä–æ—Ä-–≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞ —Å –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º –ü—Ä–∏–º–∞</p>
            
            <div class="game-description">
                <div class="description-title">–û–ü–ò–°–ê–ù–ò–ï –ò–ì–†–´</div>
                <div class="description-text">
                    –í—ã - –∑–∞–±–ª—É–¥—à–∞—è –¥—É—à–∞, –ø–æ–ø–∞–≤—à–∞—è –≤ –õ–∞–±–∏—Ä–∏–Ω—Ç –¢—å–º—ã. –ß—Ç–æ–±—ã —Å–±–µ–∂–∞—Ç—å, –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ 5 —É—Ä–æ–≤–Ω–µ–π, 
                    —Å–æ–±–∏—Ä–∞—è –∫—Ä–∏—Å—Ç–∞–ª–ª—ã-–æ—Å–∫–æ–ª–∫–∏ –∏ –Ω–∞—Ö–æ–¥—è –∫–ª—é—á–∏ –æ—Ç –¥–≤–µ—Ä–µ–π. –í–∞—Å –ø—Ä–µ—Å–ª–µ–¥—É—é—Ç –î—É—Ö–∏ –õ–∞–±–∏—Ä–∏–Ω—Ç–∞ - 
                    –∏–∑–±–µ–≥–∞–π—Ç–µ –∏—Ö –ª—é–±–æ–π —Ü–µ–Ω–æ–π! –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å —Å–ª–æ–∂–Ω–µ–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ, –∞ –ª–∞–±–∏—Ä–∏–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è 
                    –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–π –∏–≥—Ä–µ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ–º—É –∞–ª–≥–æ—Ä–∏—Ç–º—É –ü—Ä–∏–º–∞.
                </div>
            </div>
            
            <div id="menu-buttons">
                <div class="menu-button" onclick="startGame()">‚ñ∂ –ù–ê–ß–ê–¢–¨ –ò–ì–†–£</div>
                <div class="menu-button" onclick="showDifficultyMenu()">‚öô –í–´–ë–û–† –°–õ–û–ñ–ù–û–°–¢–ò</div>
                <div class="menu-button" onclick="showInstructions()">üìñ –ò–ù–°–¢–†–£–ö–¶–ò–Ø</div>
                <div class="menu-button" onclick="toggleDebug()">üêõ –†–ï–ñ–ò–ú –û–¢–õ–ê–î–ö–ò</div>
            </div>
            
            <div class="developer">–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫: –ü—Ä–æ—Å–≤–µ—Ç–æ–≤ –°–µ—Ä–≥–µ–π –ù–∏–∫–æ–ª–∞–µ–≤–∏—á</div>
        </div>
        
        <!-- –ò–ì–†–û–í–û–ô –≠–ö–†–ê–ù -->
        <div id="game-screen">
            <canvas id="game-canvas"></canvas>
            <div id="ui">
                <div class="ui-element">
                    <div>–£—Ä–æ–≤–µ–Ω—å: <span id="current-level">1</span>/5</div>
                </div>
                <div class="ui-element">
                    <div class="crystal-icon"></div>
                    <div>–ö—Ä–∏—Å—Ç–∞–ª–ª—ã: <span id="crystals">0</span>/<span id="total-crystals">3</span></div>
                </div>
                <div class="ui-element">
                    <div class="key-icon"></div>
                    <div>–ö–ª—é—á: <span id="key-status">–ù–ï–¢</span></div>
                </div>
                <div class="ui-element">
                    <div>–ñ–∏–∑–Ω–∏: <span id="hearts">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span></div>
                </div>
                <div class="ui-element">
                    <div>–°–ª–æ–∂–Ω–æ—Å—Ç—å: <span id="difficulty">–ü–æ–∫–æ–π</span></div>
                </div>
                <div class="ui-element">
                    <div>–í—Ä–µ–º—è: <span id="timer">00:00</span></div>
                </div>
                <div class="menu-button" onclick="returnToMenu()" style="margin: 10px 0 0 0; padding: 8px; font-size: 0.9rem;">
                    ‚Üê –í –ú–ï–ù–Æ
                </div>
            </div>
            
            <div id="controls-info">
                –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: WASD –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏<br>
                –¶–µ–ª—å: –°–æ–±—Ä–∞—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã ‚Üí –ù–∞–π—Ç–∏ –∫–ª—é—á ‚Üí –í—ã–π—Ç–∏ —á–µ—Ä–µ–∑ –¥–≤–µ—Ä—å
            </div>
            
            <div id="debug-info" style="display: none; position: absolute; bottom: 60px; left: 20px; background: rgba(0,0,0,0.7); color: #0f0; padding: 10px; font-size: 12px;">
                <div>–ü–æ–∑–∏—Ü–∏—è: <span id="debug-pos">0,0</span></div>
                <div>–î–≤–∏–∂–µ–Ω–∏–µ: <span id="debug-moving">–Ω–µ—Ç</span></div>
                <div>FPS: <span id="debug-fps">60</span></div>
            </div>
        </div>
        
        <!-- –≠–ö–†–ê–ù –ó–ê–í–ï–†–®–ï–ù–ò–Ø –£–†–û–í–ù–Ø -->
        <div id="level-complete">
            <h2 class="glowing-text">–£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù!</h2>
            <p>–í—Å–µ –∫—Ä–∏—Å—Ç–∞–ª–ª—ã —Å–æ–±—Ä–∞–Ω—ã, –∫–ª—é—á –Ω–∞–π–¥–µ–Ω</p>
            <p>–î–≤–µ—Ä—å –≤ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—Ç–∫—Ä—ã—Ç–∞</p>
            <div class="menu-button" onclick="nextLevel()">–°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨ ‚Üí</div>
        </div>
        
        <!-- –ú–ï–ù–Æ –í–´–ë–û–†–ê –°–õ–û–ñ–ù–û–°–¢–ò -->
        <div id="difficulty-menu">
            <div class="close-btn" onclick="hideDifficultyMenu()">√ó</div>
            <h2 class="difficulty-title">–í–´–ë–ï–†–ò–¢–ï –°–õ–û–ñ–ù–û–°–¢–¨</h2>
            <div class="difficulty-selector">
                <div class="difficulty-btn" onclick="setDifficulty('–ü–æ–∫–æ–π')">
                    –ü–û–ö–û–ô (–õ–µ–≥–∫–æ)
                    <div class="difficulty-description">‚Ä¢ –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –¥—É—Ö–∏ ‚Ä¢ –ë–æ–ª—å—à–æ–π –æ–±–∑–æ—Ä ‚Ä¢ –ú–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</div>
                </div>
                <div class="difficulty-btn" onclick="setDifficulty('–¢—Ä–µ–≤–æ–≥–∞')">
                    –¢–†–ï–í–û–ì–ê (–ù–æ—Ä–º–∞–ª—å–Ω–æ)
                    <div class="difficulty-description">‚Ä¢ –î—É—Ö–∏ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ 20% ‚Ä¢ –ù–æ—Ä–º–∞–ª—å–Ω—ã–π –æ–±–∑–æ—Ä</div>
                </div>
                <div class="difficulty-btn" onclick="setDifficulty('–°—Ç—Ä–∞—Ö')">
                    –°–¢–†–ê–• (–°–ª–æ–∂–Ω–æ)
                    <div class="difficulty-description">‚Ä¢ –û–±–∑–æ—Ä —É–º–µ–Ω—å—à–µ–Ω –Ω–∞ 30% ‚Ä¢ –î—É—Ö–∏ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞ 40%</div>
                </div>
                <div class="difficulty-btn" onclick="setDifficulty('–£–∂–∞—Å')">
                    –£–ñ–ê–° (–û—á–µ–Ω—å —Å–ª–æ–∂–Ω–æ)
                    <div class="difficulty-description">‚Ä¢ –î—É—Ö–∏ —á—É–≤—Å—Ç–≤—É—é—Ç –≤–∞—Å —á–µ—Ä–µ–∑ —Å—Ç–µ–Ω—ã ‚Ä¢ –ú–∞–ª–æ –≤—Ä–µ–º–µ–Ω–∏</div>
                </div>
                <div class="difficulty-btn" onclick="setDifficulty('–ü–∞–Ω–∏–∫–∞')">
                    –ü–ê–ù–ò–ö–ê (–≠–∫—Å–ø–µ—Ä—Ç)
                    <div class="difficulty-description">‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è ‚Ä¢ –û—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–µ –¥—É—Ö–∏</div>
                </div>
                <div class="difficulty-btn" onclick="setDifficulty('–ö–æ—à–º–∞—Ä')">
                    –ö–û–®–ú–ê–† (–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ)
                    <div class="difficulty-description">‚Ä¢ –í—Å–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ ‚Ä¢ –î–ª—è –Ω–∞—Å—Ç–æ—è—â–∏—Ö –º–∞–Ω—å—è–∫–æ–≤</div>
                </div>
            </div>
        </div>
        
        <!-- –≠–ö–†–ê–ù –ò–ù–°–¢–†–£–ö–¶–ò–ò -->
        <div id="instructions-screen">
            <div class="close-btn" onclick="hideInstructions()">√ó</div>
            <h2 class="instructions-title">üìñ –ò–ù–°–¢–†–£–ö–¶–ò–Ø</h2>
            <div class="instructions-content">
                <div class="instructions-section">
                    <div class="section-title">–¶–ï–õ–¨ –ò–ì–†–´</div>
                    <div>–ü—Ä–æ–π—Ç–∏ 5 —É—Ä–æ–≤–Ω–µ–π –ª–∞–±–∏—Ä–∏–Ω—Ç–∞, —Å–æ–±–∏—Ä–∞—è –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –∏ –Ω–∞—Ö–æ–¥—è –∫–ª—é—á–∏. 
                    –ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–≤–µ—Ä—å –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–≤–µ–Ω—å, –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –í–°–ï –∫—Ä–∏—Å—Ç–∞–ª–ª—ã 
                    –∏ –Ω–∞–π—Ç–∏ –∫–ª—é—á –Ω–∞ —É—Ä–æ–≤–Ω–µ.</div>
                </div>
                
                <div class="instructions-section">
                    <div class="section-title">–£–ü–†–ê–í–õ–ï–ù–ò–ï</div>
                    <div><strong>–ü–ö:</strong> WASD –∏–ª–∏ —Å—Ç—Ä–µ–ª–∫–∏ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è<br>
                    <strong>–ú–æ–±–∏–ª—å–Ω—ã–µ:</strong> —Å–≤–∞–π–ø—ã –ø–æ —ç–∫—Ä–∞–Ω—É<br>
                    <strong>–ü–∞—É–∑–∞:</strong> –∫–ª–∞–≤–∏—à–∞ P –∏–ª–∏ Esc</div>
                </div>
                
                <div class="instructions-section">
                    <div class="section-title">–ò–ì–†–û–í–´–ï –≠–õ–ï–ú–ï–ù–¢–´</div>
                    <div>‚Ä¢ <span style="color:#00ffff">–ö—Ä–∏—Å—Ç–∞–ª–ª—ã</span> - —Å–≤–µ—Ç—è—Ç—Å—è —Å–∏–Ω–∏–º, –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –≤—Å–µ<br>
                    ‚Ä¢ <span style="color:#ffaa00">–ö–ª—é—á</span> - —Å–≤–µ—Ç–∏—Ç—Å—è –æ—Ä–∞–Ω–∂–µ–≤—ã–º, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–≤–µ—Ä—å<br>
                    ‚Ä¢ <span style="color:#ff5555">–î—É—Ö–∏</span> - –∫—Ä–∞—Å–Ω—ã–µ –ø—Ä–∏–∑—Ä–∞–∫–∏, –∏–∑–±–µ–≥–∞–π—Ç–µ –∏—Ö!<br>
                    ‚Ä¢ <span style="color:#00ff00">–î–≤–µ—Ä—å</span> - –≤—ã—Ö–æ–¥ —Å —É—Ä–æ–≤–Ω—è (—Ç–æ–ª—å–∫–æ —Å –∫–ª—é—á–æ–º)</div>
                </div>
                
                <div class="instructions-section">
                    <div class="section-title">–°–ò–°–¢–ï–ú–ê –°–õ–û–ñ–ù–û–°–¢–ò</div>
                    <div>6 —É—Ä–æ–≤–Ω–µ–π —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –≤–ª–∏—è—é—Ç –Ω–∞:<br>
                    ‚Ä¢ –°–∫–æ—Ä–æ—Å—Ç—å –¥—É—Ö–æ–≤<br>
                    ‚Ä¢ –†–∞–¥–∏—É—Å –æ–±–∑–æ—Ä–∞<br>
                    ‚Ä¢ –í—Ä–µ–º—è –Ω–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ<br>
                    ‚Ä¢ –ü–æ–≤–µ–¥–µ–Ω–∏–µ –¥—É—Ö–æ–≤</div>
                </div>
                
                <div class="instructions-section">
                    <div class="section-title">–û–°–û–ë–ï–ù–ù–û–°–¢–ò</div>
                    <div>‚Ä¢ –õ–∞–±–∏—Ä–∏–Ω—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É –ü—Ä–∏–º–∞<br>
                    ‚Ä¢ –ö–∞–∂–¥—ã–π —É—Ä–æ–≤–µ–Ω—å —É–Ω–∏–∫–∞–ª–µ–Ω<br>
                    ‚Ä¢ 3 –∂–∏–∑–Ω–∏ –Ω–∞ –≤—Å—é –∏–≥—Ä—É<br>
                    ‚Ä¢ –ü—Ä–æ–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è —Å–ª–æ–∂–Ω–æ—Å—Ç—å<br>
                    ‚Ä¢ –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω—ã–π –∑–≤—É–∫ –∏ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò–ì–†–´ =================
        const CONFIG = {
            CELL_SIZE: 40,
            MAZE_WIDTH: 21,  // –ù–µ—á–µ—Ç–Ω–æ–µ –¥–ª—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ü—Ä–∏–º–∞
            MAZE_HEIGHT: 21, // –ù–µ—á–µ—Ç–Ω–æ–µ –¥–ª—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ü—Ä–∏–º–∞
            PLAYER_SPEED: 0.2,
            
            // –ù–ê–°–¢–†–û–ô–ö–ò –°–õ–û–ñ–ù–û–°–¢–ò
            DIFFICULTY_SETTINGS: {
                '–ü–æ–∫–æ–π': {
                    spiritSpeed: 0.02,
                    sightRadius: 250,
                    spiritCount: 2,
                    timeLimit: null,
                    spiritVision: 5
                },
                '–¢—Ä–µ–≤–æ–≥–∞': {
                    spiritSpeed: 0.03,
                    sightRadius: 220,
                    spiritCount: 3,
                    timeLimit: null,
                    spiritVision: 6
                },
                '–°—Ç—Ä–∞—Ö': {
                    spiritSpeed: 0.04,
                    sightRadius: 180,
                    spiritCount: 3,
                    timeLimit: null,
                    spiritVision: 7
                },
                '–£–∂–∞—Å': {
                    spiritSpeed: 0.05,
                    sightRadius: 140,
                    spiritCount: 4,
                    timeLimit: 300, // 5 –º–∏–Ω—É—Ç
                    spiritVision: 8
                },
                '–ü–∞–Ω–∏–∫–∞': {
                    spiritSpeed: 0.06,
                    sightRadius: 100,
                    spiritCount: 4,
                    timeLimit: 180, // 3 –º–∏–Ω—É—Ç—ã
                    spiritVision: 10
                },
                '–ö–æ—à–º–∞—Ä': {
                    spiritSpeed: 0.08,
                    sightRadius: 80,
                    spiritCount: 5,
                    timeLimit: 120, // 2 –º–∏–Ω—É—Ç—ã
                    spiritVision: 12
                }
            },
            
            // –ö–†–ò–°–¢–ê–õ–õ–´ –ü–û –£–†–û–í–ù–Ø–ú
            CRYSTALS_PER_LEVEL: [3, 4, 4, 5, 5],
            
            DEBUG_MODE: false
        };

        // ================= –ü–ï–†–ï–ú–ï–ù–ù–´–ï –ò–ì–†–´ =================
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        let gameState = 'menu';
        let currentLevel = 1;
        let crystalsCollected = 0;
        let totalCrystals = 3;
        let hasKey = false;
        let playerLives = 3;
        let difficulty = '–ü–æ–∫–æ–π';
        let currentDifficulty = CONFIG.DIFFICULTY_SETTINGS[difficulty];
        let maze = [];
        let player = { 
            x: 1, 
            y: 1, 
            gridX: 1, 
            gridY: 1,
            isMoving: false,
            moveQueue: null,
            moveProgress: 0
        };
        let crystals = [];
        let key = { x: 0, y: 0, collected: false };
        let door = { x: 0, y: 0, open: false };
        let spirits = [];
        let keysPressed = {};
        let lastTime = 0;
        let gameStartTime = 0;
        let levelStartTime = 0;
        let elapsedTime = 0;
        let frameCount = 0;
        let lastFpsUpdate = 0;
        let currentFps = 60;
        let timeLimit = null;

        // ================= –ê–õ–ì–û–†–ò–¢–ú –ü–†–ò–ú–ê =================
        function generateMazePrim(width, height) {
            const maze = Array(height).fill().map(() => Array(width).fill(1));
            const startX = 1;
            const startY = 1;
            
            maze[startY][startX] = 0;
            let walls = [];
            
            // –ù–∞—á–∞–ª—å–Ω—ã–µ —Å—Ç–µ–Ω—ã
            const initialWalls = [
                {x: startX, y: startY - 1, fromX: startX, fromY: startY},
                {x: startX, y: startY + 1, fromX: startX, fromY: startY},
                {x: startX - 1, y: startY, fromX: startX, fromY: startY},
                {x: startX + 1, y: startY, fromX: startX, fromY: startY}
            ].filter(wall => 
                wall.x > 0 && wall.x < width - 1 && 
                wall.y > 0 && wall.y < height - 1
            );
            
            walls.push(...initialWalls);
            
            while (walls.length > 0) {
                const randomIndex = Math.floor(Math.random() * walls.length);
                const wall = walls[randomIndex];
                walls.splice(randomIndex, 1);
                
                const toX = wall.x + (wall.x - wall.fromX);
                const toY = wall.y + (wall.y - wall.fromY);
                
                if (toX > 0 && toX < width - 1 && 
                    toY > 0 && toY < height - 1 && 
                    maze[toY][toX] === 1) {
                    
                    maze[wall.y][wall.x] = 0;
                    maze[toY][toX] = 0;
                    
                    const newWalls = [
                        {x: toX, y: toY - 1, fromX: toX, fromY: toY},
                        {x: toX, y: toY + 1, fromX: toX, fromY: toY},
                        {x: toX - 1, y: toY, fromX: toX, fromY: toY},
                        {x: toX + 1, y: toY, fromX: toX, fromY: toY}
                    ].filter(newWall => 
                        newWall.x > 0 && newWall.x < width - 1 && 
                        newWall.y > 0 && newWall.y < height - 1 &&
                        maze[newWall.y][newWall.x] === 1
                    );
                    
                    walls.push(...newWalls);
                }
            }
            
            // –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –≤—ã—Ö–æ–¥
            const exitX = width - 2;
            const exitY = height - 2;
            maze[exitY][exitX] = 0;
            
            // –°–æ–µ–¥–∏–Ω—è–µ–º –≤—ã—Ö–æ–¥ —Å –ª–∞–±–∏—Ä–∏–Ω—Ç–æ–º
            for (let y = exitY - 1; y <= exitY + 1; y++) {
                for (let x = exitX - 1; x <= exitX + 1; x++) {
                    if (x > 0 && x < width - 1 && y > 0 && y < height - 1) {
                        if (maze[y][x] === 0 && (x === exitX || y === exitY)) {
                            // –í—ã—Ö–æ–¥ —Å–æ–µ–¥–∏–Ω–µ–Ω
                            break;
                        }
                    }
                }
            }
            
            return maze;
        }

        // ================= –ì–ï–ù–ï–†–ê–¶–ò–Ø –£–†–û–í–ù–Ø =================
        function generateLevel(level) {
            console.log(`–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω—è ${level}, —Å–ª–æ–∂–Ω–æ—Å—Ç—å: ${difficulty}`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            currentDifficulty = CONFIG.DIFFICULTY_SETTINGS[difficulty];
            timeLimit = currentDifficulty.timeLimit;
            
            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ª–∞–±–∏—Ä–∏–Ω—Ç–∞
            maze = generateMazePrim(CONFIG.MAZE_WIDTH, CONFIG.MAZE_HEIGHT);
            
            // –°–±—Ä–æ—Å –æ–±—ä–µ–∫—Ç–æ–≤
            crystals = [];
            spirits = [];
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É—Ä–æ–≤–Ω—è
            totalCrystals = CONFIG.CRYSTALS_PER_LEVEL[level - 1] || 5;
            const spiritCount = currentDifficulty.spiritCount + Math.floor((level - 1) / 2);
            
            // –ü–æ–∑–∏—Ü–∏—è –∏–≥—Ä–æ–∫–∞
            player.gridX = 1;
            player.gridY = 1;
            player.x = 1;
            player.y = 1;
            player.isMoving = false;
            player.moveQueue = null;
            player.moveProgress = 0;
            
            // –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–ª–µ—Ç–∫–∏
            const availableCells = [];
            for (let y = 0; y < maze.length; y++) {
                for (let x = 0; x < maze[y].length; x++) {
                    if (maze[y][x] === 0 && 
                        !(x === 1 && y === 1) &&
                        distance(x, y, 1, 1) > 5) {
                        availableCells.push({ x, y });
                    }
                }
            }
            
            shuffleArray(availableCells);
            
            // –ö—Ä–∏—Å—Ç–∞–ª–ª—ã
            for (let i = 0; i < totalCrystals && availableCells.length > 0; i++) {
                const cell = availableCells.pop();
                crystals.push({
                    x: cell.x,
                    y: cell.y,
                    collected: false,
                    pulse: Math.random() * Math.PI * 2
                });
            }
            
            // –ö–ª—é—á
            if (availableCells.length > 0) {
                const keyCell = availableCells.pop();
                key = {
                    x: keyCell.x,
                    y: keyCell.y,
                    collected: false
                };
            }
            
            // –î–≤–µ—Ä—å
            door = {
                x: CONFIG.MAZE_WIDTH - 2,
                y: CONFIG.MAZE_HEIGHT - 2,
                open: false
            };
            
            // –î—É—Ö–∏
            for (let i = 0; i < spiritCount && availableCells.length > 0; i++) {
                const cell = availableCells.pop();
                spirits.push({
                    x: cell.x,
                    y: cell.y,
                    gridX: cell.x,
                    gridY: cell.y,
                    targetX: cell.x,
                    targetY: cell.y,
                    speed: currentDifficulty.spiritSpeed * (1 + (level - 1) * 0.2),
                    phase: Math.random() * Math.PI * 2,
                    moveCooldown: 0,
                    visionRange: currentDifficulty.spiritVision
                });
            }
            
            // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π
            crystalsCollected = 0;
            hasKey = false;
            door.open = false;
            levelStartTime = Date.now();
            
            console.log(`–£—Ä–æ–≤–µ–Ω—å ${level} –≥–æ—Ç–æ–≤. –î—É—Ö–æ–≤: ${spiritCount}, –ö—Ä–∏—Å—Ç–∞–ª–ª–æ–≤: ${totalCrystals}`);
        }

        // ================= –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò =================
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function distance(x1, y1, x2, y2) {
            return Math.sqrt((x2 - x1) ** 2 + (y2 - y1) ** 2);
        }

        function canMoveTo(x, y) {
            return (
                x >= 0 && x < CONFIG.MAZE_WIDTH &&
                y >= 0 && y < CONFIG.MAZE_HEIGHT &&
                maze[y][x] === 0
            );
        }

        function updateTimerDisplay() {
            const currentTime = Date.now();
            elapsedTime = Math.floor((currentTime - levelStartTime) / 1000);
            
            if (timeLimit) {
                const remaining = timeLimit - elapsedTime;
                if (remaining <= 0) {
                    timeOut();
                    return;
                }
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                const minutes = Math.floor(elapsedTime / 60);
                const seconds = elapsedTime % 60;
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        // ================= –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ì–†–´ =================
        function update(deltaTime) {
            if (gameState !== 'playing') return;
            
            frameCount++;
            const currentTime = Date.now();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ FPS –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            if (currentTime - lastFpsUpdate >= 1000) {
                currentFps = Math.round((frameCount * 1000) / (currentTime - lastFpsUpdate));
                frameCount = 0;
                lastFpsUpdate = currentTime;
                
                if (CONFIG.DEBUG_MODE) {
                    document.getElementById('debug-fps').textContent = currentFps;
                }
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞
            updateTimerDisplay();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
            updatePlayer(deltaTime);
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥—É—Ö–æ–≤
            updateSpirits(deltaTime);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
            checkCollisions();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–µ–±–∞–≥-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            if (CONFIG.DEBUG_MODE) {
                updateDebugInfo();
            }
        }

        function updatePlayer(deltaTime) {
            // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
            if (player.moveQueue && player.moveProgress < 1) {
                player.moveProgress += CONFIG.PLAYER_SPEED * deltaTime / 16;
                
                if (player.moveProgress >= 1) {
                    player.moveProgress = 1;
                    player.x = player.moveQueue.toX;
                    player.y = player.moveQueue.toY;
                    player.gridX = Math.round(player.x);
                    player.gridY = Math.round(player.y);
                    player.moveQueue = null;
                    player.isMoving = false;
                } else {
                    player.x = player.moveQueue.fromX + (player.moveQueue.toX - player.moveQueue.fromX) * player.moveProgress;
                    player.y = player.moveQueue.fromY + (player.moveQueue.toY - player.moveQueue.fromY) * player.moveProgress;
                }
                return;
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞
            let targetX = player.gridX;
            let targetY = player.gridY;
            let moved = false;
            
            if (keysPressed['ArrowUp'] || keysPressed['w'] || keysPressed['W']) {
                targetY--;
                moved = true;
            } else if (keysPressed['ArrowDown'] || keysPressed['s'] || keysPressed['S']) {
                targetY++;
                moved = true;
            } else if (keysPressed['ArrowLeft'] || keysPressed['a'] || keysPressed['A']) {
                targetX--;
                moved = true;
            } else if (keysPressed['ArrowRight'] || keysPressed['d'] || keysPressed['D']) {
                targetX++;
                moved = true;
            }
            
            // –ù–∞—á–∞–ª–æ –Ω–æ–≤–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
            if (moved && canMoveTo(targetX, targetY) && !player.isMoving) {
                player.moveQueue = {
                    fromX: player.x,
                    fromY: player.y,
                    toX: targetX,
                    toY: targetY
                };
                player.moveProgress = 0;
                player.isMoving = true;
                player.gridX = targetX;
                player.gridY = targetY;
            }
        }

        function updateSpirits(deltaTime) {
            spirits.forEach(spirit => {
                // –ê–Ω–∏–º–∞—Ü–∏—è
                spirit.phase += 0.02 * deltaTime / 16;
                
                // –ò–ò –¥—É—Ö–æ–≤
                if (spirit.moveCooldown <= 0) {
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ –∏–≥—Ä–æ–∫–∞
                    const playerDist = distance(spirit.gridX, spirit.gridY, player.gridX, player.gridY);
                    
                    if (playerDist <= spirit.visionRange) {
                        // –ü—Ä–µc–ª–µ–¥–æ–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
                        const directions = [
                            {dx: 0, dy: -1},
                            {dx: 1, dy: 0},
                            {dx: 0, dy: 1},
                            {dx: -1, dy: 0}
                        ];
                        
                        // –í—ã–±–∏—Ä–∞–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É
                        let bestDir = null;
                        let bestDist = Infinity;
                        
                        for (const dir of directions) {
                            const newX = spirit.gridX + dir.dx;
                            const newY = spirit.gridY + dir.dy;
                            
                            if (canMoveTo(newX, newY)) {
                                const dist = distance(newX, newY, player.gridX, player.gridY);
                                if (dist < bestDist) {
                                    bestDist = dist;
                                    bestDir = dir;
                                }
                            }
                        }
                        
                        if (bestDir) {
                            spirit.targetX = spirit.gridX + bestDir.dx;
                            spirit.targetY = spirit.gridY + bestDir.dy;
                        }
                    } else {
                        // –°–ª—É—á–∞–π–Ω–æ–µ –±–ª—É–∂–¥–∞–Ω–∏–µ
                        const directions = [
                            {dx: 0, dy: -1},
                            {dx: 1, dy: 0},
                            {dx: 0, dy: 1},
                            {dx: -1, dy: 0}
                        ].filter(dir => canMoveTo(spirit.gridX + dir.dx, spirit.gridY + dir.dy));
                        
                        if (directions.length > 0) {
                            const dir = directions[Math.floor(Math.random() * directions.length)];
                            spirit.targetX = spirit.gridX + dir.dx;
                            spirit.targetY = spirit.gridY + dir.dy;
                        }
                    }
                    
                    spirit.moveCooldown = 30 + Math.random() * 60;
                } else {
                    spirit.moveCooldown -= deltaTime / 16;
                }
                
                // –î–≤–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
                const dx = spirit.targetX - spirit.x;
                const dy = spirit.targetY - spirit.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > 0.05) {
                    spirit.x += (dx / dist) * spirit.speed * deltaTime / 16;
                    spirit.y += (dy / dist) * spirit.speed * deltaTime / 16;
                } else {
                    spirit.x = spirit.targetX;
                    spirit.y = spirit.targetY;
                    spirit.gridX = Math.round(spirit.x);
                    spirit.gridY = Math.round(spirit.y);
                }
            });
        }

        function checkCollisions() {
            // –ö—Ä–∏—Å—Ç–∞–ª–ª—ã
            crystals.forEach(crystal => {
                if (!crystal.collected && 
                    Math.abs(player.x - crystal.x) < 0.5 && 
                    Math.abs(player.y - crystal.y) < 0.5) {
                    crystal.collected = true;
                    crystalsCollected++;
                    updateUI();
                }
            });
            
            // –ö–ª—é—á
            if (!key.collected && 
                Math.abs(player.x - key.x) < 0.5 && 
                Math.abs(player.y - key.y) < 0.5) {
                key.collected = true;
                hasKey = true;
                updateUI();
            }
            
            // –î–≤–µ—Ä—å
            if (Math.abs(player.x - door.x) < 0.7 && 
                Math.abs(player.y - door.y) < 0.7) {
                if (crystalsCollected === totalCrystals && hasKey) {
                    door.open = true;
                    completeLevel();
                }
            }
            
            // –î—É—Ö–∏
            spirits.forEach(spirit => {
                const dist = distance(player.x, player.y, spirit.x, spirit.y);
                
                if (dist < 0.7) {
                    playerLives--;
                    updateUI();
                    
                    // –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏
                    player.x = 1;
                    player.y = 1;
                    player.gridX = 1;
                    player.gridY = 1;
                    player.isMoving = false;
                    player.moveQueue = null;
                    
                    if (playerLives <= 0) {
                        gameOver();
                    }
                }
            });
        }

        function updateDebugInfo() {
            document.getElementById('debug-pos').textContent = 
                `${player.x.toFixed(2)}, ${player.y.toFixed(2)}`;
            document.getElementById('debug-moving').textContent = 
                player.isMoving ? '–¥–∞' : '–Ω–µ—Ç';
        }

        // ================= –û–¢–†–ò–°–û–í–ö–ê =================
        function draw() {
            // –û—á–∏—Å—Ç–∫–∞
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // –°–º–µ—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
            const offsetX = canvas.width / 2 - player.x * CONFIG.CELL_SIZE;
            const offsetY = canvas.height / 2 - player.y * CONFIG.CELL_SIZE;
            
            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            drawMaze(offsetX, offsetY);
            drawCrystals(offsetX, offsetY);
            drawKey(offsetX, offsetY);
            drawDoor(offsetX, offsetY);
            drawSpirits(offsetX, offsetY);
            drawPlayer(offsetX, offsetY);
            drawFogOfWar();
        }

        function drawMaze(offsetX, offsetY) {
            const cs = CONFIG.CELL_SIZE;
            
            for (let y = 0; y < maze.length; y++) {
                for (let x = 0; x < maze[y].length; x++) {
                    if (maze[y][x] === 1) {
                        ctx.fillStyle = '#111';
                        ctx.fillRect(x * cs + offsetX, y * cs + offsetY, cs, cs);
                        
                        // –¢–µ–∫—Å—Ç—É—Ä–∞
                        ctx.fillStyle = '#222';
                        for (let i = 0; i < 2; i++) {
                            const rx = Math.random() * cs;
                            const ry = Math.random() * cs;
                            ctx.fillRect(x * cs + offsetX + rx, y * cs + offsetY + ry, 2, 2);
                        }
                    }
                }
            }
        }

        function drawCrystals(offsetX, offsetY) {
            const cs = CONFIG.CELL_SIZE;
            
            crystals.forEach(crystal => {
                if (!crystal.collected) {
                    crystal.pulse += 0.05;
                    const size = 8 + Math.sin(crystal.pulse) * 2;
                    
                    ctx.shadowColor = '#00ffff';
                    ctx.shadowBlur = 15;
                    ctx.fillStyle = '#00ffff';
                    ctx.beginPath();
                    ctx.arc(
                        crystal.x * cs + cs/2 + offsetX,
                        crystal.y * cs + cs/2 + offsetY,
                        size,
                        0,
                        Math.PI * 2
                    );
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });
        }

        function drawKey(offsetX, offsetY) {
            const cs = CONFIG.CELL_SIZE;
            
            if (!key.collected) {
                ctx.shadowColor = '#ffaa00';
                ctx.shadowBlur = 10;
                ctx.fillStyle = '#ffaa00';
                ctx.fillRect(
                    key.x * cs + cs/4 + offsetX,
                    key.y * cs + cs/3 + offsetY,
                    cs/2,
                    cs/3
                );
                ctx.shadowBlur = 0;
            }
        }

        function drawDoor(offsetX, offsetY) {
            const cs = CONFIG.CELL_SIZE;
            
            ctx.fillStyle = door.open ? '#006600' : '#660000';
            ctx.fillRect(door.x * cs + offsetX, door.y * cs + offsetY, cs, cs);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(
                door.open ? '‚úì' : '‚úó',
                door.x * cs + cs/2 + offsetX,
                door.y * cs + cs/2 + offsetY
            );
        }

        function drawSpirits(offsetX, offsetY) {
            const cs = CONFIG.CELL_SIZE;
            
            spirits.forEach(spirit => {
                const floatY = Math.sin(spirit.phase) * 3;
                
                ctx.shadowColor = '#ff0000';
                ctx.shadowBlur = 20;
                ctx.fillStyle = 'rgba(255, 50, 50, 0.8)';
                ctx.beginPath();
                ctx.arc(
                    spirit.x * cs + cs/2 + offsetX,
                    spirit.y * cs + cs/2 + offsetY + floatY,
                    10,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
                ctx.shadowBlur = 0;
                
                // –ì–ª–∞–∑–∞
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(
                    spirit.x * cs + cs/2 - 3 + offsetX,
                    spirit.y * cs + cs/2 - 3 + offsetY + floatY,
                    2,
                    0,
                    Math.PI * 2
                );
                ctx.arc(
                    spirit.x * cs + cs/2 + 3 + offsetX,
                    spirit.y * cs + cs/2 - 3 + offsetY + floatY,
                    2,
                    0,
                    Math.PI * 2
                );
                ctx.fill();
            });
        }

        function drawPlayer(offsetX, offsetY) {
            const cs = CONFIG.CELL_SIZE;
            
            ctx.shadowColor = '#00ffff';
            ctx.shadowBlur = 25;
            ctx.fillStyle = '#00ffff';
            ctx.beginPath();
            ctx.arc(
                player.x * cs + cs/2 + offsetX,
                player.y * cs + cs/2 + offsetY,
                12,
                0,
                Math.PI * 2
            );
            ctx.fill();
            ctx.shadowBlur = 0;
            
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.arc(
                player.x * cs + cs/2 + offsetX,
                player.y * cs + cs/2 + offsetY,
                8,
                0,
                Math.PI * 2
            );
            ctx.fill();
        }

        function drawFogOfWar() {
            const radius = currentDifficulty.sightRadius;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            const gradient = ctx.createRadialGradient(
                centerX, centerY, radius * 0.3,
                centerX, centerY, radius
            );
            gradient.addColorStop(0, 'rgba(0, 0, 0, 0)');
            gradient.addColorStop(1, 'rgba(0, 0, 0, 0.9)');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // ================= –£–ü–†–ê–í–õ–ï–ù–ò–ï =================
        document.addEventListener('keydown', (e) => {
            keysPressed[e.key] = true;
            
            // –ü–∞—É–∑–∞
            if (e.key === 'p' || e.key === 'P' || e.key === 'Escape') {
                if (gameState === 'playing') {
                    gameState = 'paused';
                } else if (gameState === 'paused') {
                    gameState = 'playing';
                    lastTime = performance.now();
                }
                e.preventDefault();
            }
            
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' ', 'w', 'a', 's', 'd'].includes(e.key)) {
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            keysPressed[e.key] = false;
        });

        // –ú–æ–±–∏–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
        let touchStart = { x: 0, y: 0 };
        
        canvas.addEventListener('touchstart', (e) => {
            touchStart.x = e.touches[0].clientX;
            touchStart.y = e.touches[0].clientY;
            e.preventDefault();
        }, { passive: false });
        
        canvas.addEventListener('touchend', (e) => {
            if (gameState !== 'playing' || player.isMoving) return;
            
            const touchEnd = {
                x: e.changedTouches[0].clientX,
                y: e.changedTouches[0].clientY
            };
            
            const dx = touchEnd.x - touchStart.x;
            const dy = touchEnd.y - touchStart.y;
            
            let targetX = player.gridX;
            let targetY = player.gridY;
            
            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 30) targetX++;
                else if (dx < -30) targetX--;
            } else {
                if (dy > 30) targetY++;
                else if (dy < -30) targetY--;
            }
            
            if (canMoveTo(targetX, targetY) && !player.isMoving) {
                player.moveQueue = {
                    fromX: player.x,
                    fromY: player.y,
                    toX: targetX,
                    toY: targetY
                };
                player.moveProgress = 0;
                player.isMoving = true;
                player.gridX = targetX;
                player.gridY = targetY;
            }
            
            e.preventDefault();
        }, { passive: false });

        // ================= –ò–ì–†–û–í–û–ô –¶–ò–ö–õ =================
        function gameLoop(timestamp) {
            if (!lastTime) lastTime = timestamp;
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            if (gameState === 'playing') {
                update(deltaTime);
                draw();
            } else if (gameState === 'paused') {
                // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —ç–∫—Ä–∞–Ω–∞ –ø–∞—É–∑—ã
                draw();
                drawPauseScreen();
            }
            
            requestAnimationFrame(gameLoop);
        }

        function drawPauseScreen() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('–ü–ê–£–ó–ê', canvas.width / 2, canvas.height / 2 - 50);
            
            ctx.font = '24px Arial';
            ctx.fillText('–ù–∞–∂–º–∏—Ç–µ P –∏–ª–∏ ESC –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è', canvas.width / 2, canvas.height / 2 + 20);
            ctx.fillText('–°–ª–æ–∂–Ω–æ—Å—Ç—å: ' + difficulty, canvas.width / 2, canvas.height / 2 + 60);
        }

        // ================= –ò–ù–¢–ï–†–§–ï–ô–° =================
        function updateUI() {
            document.getElementById('current-level').textContent = currentLevel;
            document.getElementById('crystals').textContent = crystalsCollected;
            document.getElementById('total-crystals').textContent = totalCrystals;
            document.getElementById('key-status').textContent = hasKey ? '–î–ê' : '–ù–ï–¢';
            document.getElementById('difficulty').textContent = difficulty;
            
            let hearts = '';
            for (let i = 0; i < 3; i++) {
                hearts += i < playerLives ? '‚ù§Ô∏è' : 'üñ§';
            }
            document.getElementById('hearts').innerHTML = hearts;
        }

        // ================= –ò–ì–†–û–í–´–ï –°–û–ë–´–¢–ò–Ø =================
        function startGame() {
            gameState = 'playing';
            currentLevel = 1;
            playerLives = 3;
            keysPressed = {};
            lastTime = 0;
            gameStartTime = Date.now();
            frameCount = 0;
            lastFpsUpdate = Date.now();
            
            document.getElementById('menu-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            
            generateLevel(currentLevel);
            updateUI();
            
            requestAnimationFrame(gameLoop);
            console.log(`–ò–≥—Ä–∞ –Ω–∞—á–∞—Ç–∞. –°–ª–æ–∂–Ω–æ—Å—Ç—å: ${difficulty}`);
        }

        function completeLevel() {
            gameState = 'levelComplete';
            document.getElementById('level-complete').style.display = 'block';
            console.log(`–£—Ä–æ–≤–µ–Ω—å ${currentLevel} –ø—Ä–æ–π–¥–µ–Ω –∑–∞ ${elapsedTime} —Å–µ–∫.`);
        }

        function nextLevel() {
            if (currentLevel < 5) {
                currentLevel++;
                document.getElementById('level-complete').style.display = 'none';
                generateLevel(currentLevel);
                updateUI();
                gameState = 'playing';
                console.log(`–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è —É—Ä–æ–≤–µ–Ω—å ${currentLevel}`);
            } else {
                const totalTime = Math.floor((Date.now() - gameStartTime) / 1000);
                alert(`üéâ –ü–û–ë–ï–î–ê!\n–í—ã –ø—Ä–æ—à–ª–∏ –≤—Å–µ 5 —É—Ä–æ–≤–Ω–µ–π –õ–∞–±–∏—Ä–∏–Ω—Ç–∞ –¢—å–º—ã!\n–û–±—â–µ–µ –≤—Ä–µ–º—è: ${Math.floor(totalTime/60)}:${(totalTime%60).toString().padStart(2,'0')}\n–°–ª–æ–∂–Ω–æ—Å—Ç—å: ${difficulty}`);
                returnToMenu();
            }
        }

        function timeOut() {
            alert('‚è∞ –í–†–ï–ú–Ø –í–´–®–õ–û!\n–î—É—Ö–∏ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞ –ø–æ–π–º–∞–ª–∏ –≤–∞—Å...');
            gameOver();
        }

        function gameOver() {
            alert('‚ò†Ô∏è –í–ê–° –ü–û–ì–õ–û–¢–ò–õ–ê –¢–¨–ú–ê\n–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞');
            returnToMenu();
        }

        function returnToMenu() {
            gameState = 'menu';
            document.getElementById('menu-screen').style.display = 'flex';
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('level-complete').style.display = 'none';
            document.getElementById('debug-info').style.display = 'none';
        }

        // ================= –ú–ï–ù–Æ –°–õ–û–ñ–ù–û–°–¢–ò =================
        function showDifficultyMenu() {
            // –°–±—Ä–æ—Å –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(difficulty)) {
                    btn.classList.add('active');
                }
            });
            
            document.getElementById('difficulty-menu').style.display = 'block';
        }

        function hideDifficultyMenu() {
            document.getElementById('difficulty-menu').style.display = 'none';
        }

        function setDifficulty(level) {
            difficulty = level;
            currentDifficulty = CONFIG.DIFFICULTY_SETTINGS[level];
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes(level)) {
                    btn.classList.add('active');
                }
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI
            document.getElementById('difficulty').textContent = difficulty;
            
            hideDifficultyMenu();
            console.log(`–°–ª–æ–∂–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞: ${difficulty}`);
        }

        // ================= –ò–ù–°–¢–†–£–ö–¶–ò–Ø =================
        function showInstructions() {
            document.getElementById('instructions-screen').style.display = 'block';
        }

        function hideInstructions() {
            document.getElementById('instructions-screen').style.display = 'none';
        }

        function toggleDebug() {
            CONFIG.DEBUG_MODE = !CONFIG.DEBUG_MODE;
            const debugInfo = document.getElementById('debug-info');
            debugInfo.style.display = CONFIG.DEBUG_MODE ? 'block' : 'none';
            console.log(`–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: ${CONFIG.DEBUG_MODE ? '–í–ö–õ' : '–í–´–ö–õ'}`);
        }

        // ================= –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =================
        window.onload = function() {
            updateUI();
            console.log('–ò–≥—Ä–∞ "–õ–∞–±–∏—Ä–∏–Ω—Ç –¢—å–º—ã" –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
            setDifficulty('–ü–æ–∫–æ–π');
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
            window.addEventListener('resize', () => {
                if (gameState === 'playing' || gameState === 'paused') {
                    draw();
                    if (gameState === 'paused') drawPauseScreen();
                }
            });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());
        };
    </script>
</body>
</html>
